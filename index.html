<!DOCTYPE html>
<html lang="en">

<head>
    <title>Cardboard Example</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <style>
        body {
            margin: 0px;
            overflow: hidden;
        }
        
        #example {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }
    </style>
</head>

<body>
    <div id="example"></div>

    <script src="js/third-party/threejs/three.js"></script>
    <script src="js/third-party/threejs/CanvasTexture.js"></script>
    <script src="js/third-party/threejs/StereoEffect.js"></script>
    <script src="js/third-party/threejs/DeviceOrientationControls.js"></script>
    <script src="js/third-party/threejs/OrbitControls.js"></script>
    <script src="js/apis/speech.js"></script>

    <script src="js/renderers/Projector.js"></script>
    <script src="js/renderers/CanvasRenderer.js"></script>
    <script src="js/ImprovedNoise.js"></script>
    <script src="js/terrain.js"></script>


    <script>
        clock = new THREE.Clock();

        var mesh;

        init();
        animate();

        function init() {
            renderer = new THREE.WebGLRenderer();
            element = renderer.domElement;
            container = document.getElementById('example');
            container.appendChild(element);

            effect = new THREE.StereoEffect(renderer);

            scene = new THREE.Scene();

            camera = new THREE.PerspectiveCamera(90, 1, 0.001, 700);
            camera.position.set(10, 30, 0);
            scene.add(camera);

            controls = new THREE.OrbitControls(camera, element);
            controls.rotateUp(Math.PI / 4);
            //            controls.target.set( // camera.position.x + 0.1, // camera.position.y, // camera.position.z // );
            controls.noZoom = true;
            controls.noPan = true;
            controls.addEventListener('change', render);

            controls.pan(1, 1);

            window.onkeydown = function (e) {
                var key = e.keyCode ? e.keyCode : e.which;

                if (key == 38) { //up key
                    goForward();
                } else if (key == 40) { //down key
                    goBack();
                } else if (key == 39) { //right key
                    goRight();
                } else if (key == 37) { //left key
                    goLeft();
                }
            }

            /* terrain */
            var data = generateHeight(1024, 1024);
            var texture = new THREE.CanvasTexture(generateTexture(data, 1024, 1024));
            var material = new THREE.MeshBasicMaterial({
                map: texture,
                overdraw: 0.5
            });

            var quality = 16,
                step = 1024 / quality;

            var geometry = new THREE.PlaneGeometry(2000, 2000, quality - 1, quality - 1);
            geometry.rotateX(-Math.PI / 2);

            for (var i = 0, l = geometry.vertices.length; i < l; i++) {

                var x = i % quality,
                    y = Math.floor(i / quality);
                geometry.vertices[i].y = data[(x * step) + (y * step) * 1024] * 2 - 128;

            }

            mesh = new THREE.Mesh(geometry, material);

            scene.add(mesh);

            function goForward() {
                var originalPos = camera.position;
                var newPosX = originalPos.x - 0.1;

                camera.position.set(newPosX, camera.position.y, camera.position.z);

                controls.target.set(
                    newPosX - 0.1,
                    originalPos.y,
                    originalPos.z
                );
            }

            function goBack() {

            }

            function goLeft() {
                controls.pan(1, 0);
            }

            function goRight() {
                controls.pan(-1, 0);
            }

            function setOrientationControls(e) {
                if (!e.alpha) {
                    return;
                }

                controls = new THREE.DeviceOrientationControls(camera, true);
                controls.connect();
                controls.update();
                element.addEventListener('click', fullscreen, false);

                window.removeEventListener('deviceorientation', setOrientationControls, true);
            }
            window.addEventListener('deviceorientation', setOrientationControls, true);


            var light = new THREE.HemisphereLight(0x777777, 0x000000, 0.6);
            scene.add(light);

            //            var texture = THREE.ImageUtils.loadTexture(
            //                'textures/patterns/wood-plastered-red.png'
            //            );
            //            texture.wrapS = THREE.RepeatWrapping;
            //            texture.wrapT = THREE.RepeatWrapping;
            //            texture.repeat = new THREE.Vector2(50, 50);
            //            texture.anisotropy = renderer.getMaxAnisotropy();
            //
            //            var material = new THREE.MeshPhongMaterial({
            //                color: 0xffffff,
            //                specular: 0xffffff,
            //                shininess: 20,
            //                shading: THREE.FlatShading,
            //                map: texture
            //            });
            //
            //            var geometry = new THREE.PlaneGeometry(1000, 1000);
            //
            //            var mesh = new THREE.Mesh(geometry, material);
            //            mesh.rotation.x = -Math.PI / 2;
            //            scene.add(mesh);

            window.addEventListener('resize', resize, false);
            setTimeout(resize, 1);
        }

        function resize() {
            var width = container.offsetWidth;
            var height = container.offsetHeight;

            camera.aspect = width / height;
            camera.updateProjectionMatrix();

            renderer.setSize(width, height);
            effect.setSize(width, height);
        }

        function update(dt) {
            resize();

            camera.updateProjectionMatrix();

            controls.update(dt);
        }

        function render(dt) {
            effect.render(scene, camera);
        }

        function animate(t) {
            requestAnimationFrame(animate);
            //camera.translateX(velocity.X);
            //camera.translateY(velocity.Y);
            //camera.translateZ(velocity.Z);

            update(clock.getDelta());
            render(clock.getDelta());
        }

        function fullscreen() {
            if (container.requestFullscreen) {
                container.requestFullscreen();
            } else if (container.msRequestFullscreen) {
                container.msRequestFullscreen();
            } else if (container.mozRequestFullScreen) {
                container.mozRequestFullScreen();
            } else if (container.webkitRequestFullscreen) {
                container.webkitRequestFullscreen();
            }
        }
    </script>
</body>

</html>